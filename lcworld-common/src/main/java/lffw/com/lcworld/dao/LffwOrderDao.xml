<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lcworld.dao.LffwOrderDao">
 
	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.lcworld.entity.LffwOrderEntity" id="lffwOrderMap">
        <result property="id" column="id"/>
        <result property="ordercode" column="ordercode"/>
        <result property="uid" column="uid"/>
        <result property="barberid" column="barberid"/>
        <result property="createtime" column="createtime"/>
        <result property="mobile" column="mobile"/>
        <result property="remark" column="remark"/>
        <result property="status" column="status"/>
        <result property="changes" column="changes"/>
        <result property="price" column="price"/>
        <result property="paytime" column="paytime"/>
        <result property="paytype" column="paytype"/>
        <result property="isdel" column="isdel"/>
        <result property="paystatus" column="paystatus"/>
        <result property="scheduleid" column="scheduleid"/>
        <result property="scheduledate" column="scheduledate"/>
        <result property="cancelreason" column="cancelreason"/>
        <result property="mixpay" column="mixpay"/>
        <result property="lockvouchercount" column="lockvouchercount"/>
        <result property="refundstatus" column="refundstatus"/>
        <result property="checkstatus" column="checkstatus"/>
    </resultMap>

	<select id="queryObject" resultType="com.lcworld.entity.LffwOrderEntity">
		select * from t_lffw_order where id = #{value}
	</select>

	<select id="queryList" resultType="com.lcworld.entity.LffwOrderEntity">
		select * from t_lffw_order where 1=1
		<if test="uid != null">
		  and uid =#{uid}
		</if>
		<if test="payordercode != null and payordercode.trim() != ''">
		  and ordercode =#{payordercode}
		</if>
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
			<otherwise>
                order by id desc
			</otherwise>
        </choose>
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>
	
 	<select id="queryTotal" resultType="int">
		select count(*) from t_lffw_order 
	</select>
	 
	<insert id="save" parameterType="com.lcworld.entity.LffwOrderEntity" useGeneratedKeys="true" keyProperty="id">
		insert into t_lffw_order
		(
			`ordercode`, 
			`uid`, 
			`barberid`, 
			`createtime`, 
			`mobile`, 
			`remark`, 
			`status`, 
			`changes`, 
			`price`, 
			`paytime`, 
			`paytype`, 
			`isdel`, 
			`paystatus`, 
			`scheduleid`,
			`scheduledate`,
			`cancelreason`,
			`mixpay`,
			`lockvouchercount`,
			`refundstatus`,
			`checkstatus`
		)
		values
		(
			#{ordercode}, 
			#{uid}, 
			#{barberid}, 
			#{createtime}, 
			#{mobile}, 
			#{remark}, 
			#{status}, 
			#{changes}, 
			#{price}, 
			#{paytime}, 
			#{paytype}, 
			#{isdel}, 
			#{paystatus}, 
			#{scheduleid},
			#{scheduledate},
			#{cancelreason},
			#{mixpay},
			#{lockvouchercount},
			#{refundstatus},
			#{checkstatus}
		)
	</insert>
	 
	<update id="update" parameterType="com.lcworld.entity.LffwOrderEntity">
		update t_lffw_order 
		<set>
			<if test="ordercode != null">`ordercode` = #{ordercode}, </if>
			<if test="uid != null">`uid` = #{uid}, </if>
			<if test="barberid != null">`barberid` = #{barberid}, </if>
			<if test="createtime != null">`createtime` = #{createtime}, </if>
			<if test="mobile != null">`mobile` = #{mobile}, </if>
			<if test="remark != null">`remark` = #{remark}, </if>
			<if test="status != null">`status` = #{status}, </if>
			<if test="changes != null">`changes` = #{changes}, </if>
			<if test="price != null">`price` = #{price}, </if>
			<if test="paytime != null">`paytime` = #{paytime}, </if>
			<if test="paytype != null">`paytype` = #{paytype}, </if>
			<if test="isdel != null">`isdel` = #{isdel}, </if>
			<if test="paystatus != null">`paystatus` = #{paystatus}, </if>
			<if test="scheduleid != null">`scheduleid` = #{scheduleid},</if>
			<if test="scheduledate != null">`scheduledate` = #{scheduledate},</if>
			<if test="cancelreason != null">`cancelreason` = #{cancelreason},</if>
			<if test="mixpay != null">`mixpay` = #{mixpay},</if>
			<if test="refundstatus != null">`refundstatus` = #{refundstatus},</if>
			<if test="lockvouchercount != null">`lockvouchercount` = #{lockvouchercount},</if>
			<if test="checkstatus != null">`checkstatus` = #{checkstatus}</if>
		</set>
		where id = #{id}
	</update>
	
	<delete id="delete">
		delete from t_lffw_order where id = #{value}
	</delete>
	
	<delete id="deleteBatch">
		delete from t_lffw_order where id in 
		<foreach item="id" collection="array" open="(" separator="," close=")">
			#{id}
		</foreach>
	</delete>
	
	<select id="queryOrderlist" resultType="com.lcworld.dto.LffwOrderDTO">
       SELECT
		    a.id orderid,
		    a.ordercode,
		    a.uid,
		    a.barberid,
		    DATE_FORMAT(a.createtime, '%Y-%m-%d %H:%i') createtime,
		    a.`status`,
		    a.changes,
		    a.price,
		    a.paytime,
		    a.paytype,
		    a.paystatus,
		    a.checkstatus,
		    a.isdel,
		    b.`name` realname,
		    b.photo,
		    b.mobile,
		    b.score,
		      IFNULL(a.checkstatus,0) checkstatus,
		    CONCAT(
		        DATE_FORMAT(c.scheduledate, '%Y-%m-%d'),
		        ' ',
		        d.starttime
		    ) invitetime
		FROM
		    t_lffw_order a
		left JOIN t_lffw_barber b ON a.barberid = b.id
		left JOIN t_lffw_barber_schedule c ON c.id = a.scheduleid
		left JOIN t_lffw_period d ON d.id = c.consultperiodid
		where    a.isdel =0
		<if test="uid != null and uid != ''">
		  and a.uid =#{uid}
		</if>
		  <if test="orderid != null and orderid != ''">
            and a.id =#{orderid}
        </if>
         <if test="statuslist != null and statuslist.size > 0">
          and a.status in 
           <foreach item="id" collection="statuslist" open="(" separator="," close=")">
            #{id}
        </foreach>
        </if>
		order by a.createtime desc 
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>
    </select>
    
    <select id="queryorderList1" resultType="map">
        SELECT
            a.*,b.`name` barbername,c.realname username
		FROM
		    t_lffw_order a
		left JOIN t_lffw_barber b ON a.barberid = b.id
		INNER JOIN t_user c ON a.uid = c.id
		 <if test="ordercode != null and ordercode != ''" > and a.ordercode like '%${ordercode}%'</if>
           <if test="username != null and username != ''" > and c.realname like  '%${username}%'</if>
           <if test="barbername != null and barbername != ''" > and b.name like  '%${barbername}%'</if>
         <if test="status != null and status != ''" > and a.status = #{status}</if>
         <if test="paystatus != null and paystatus != ''" > and a.paystatus = #{paystatus}</if>
           <if test="starttime != null and starttime != ''"> and a.scheduledate &gt;= str_to_date(#{starttime},'%Y-%m-%d %H:%i')</if>
           <if test="endtime != null and endtime != ''"> and a.scheduledate &lt;= str_to_date(#{endtime},'%Y-%m-%d %H:%i')</if>
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
            <otherwise>
                order by id desc
            </otherwise>
        </choose>
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>
    </select>
    
    <select id="queryorderTotal" resultType="int">
       SELECT
            count(*)
        FROM
            t_lffw_order a
        left JOIN t_lffw_barber b ON a.barberid = b.id
        INNER JOIN t_user c ON a.uid = c.id 
        <if test="paystatus != null and paystatus != ''" > and a.paystatus = #{paystatus}</if>
           <if test="status != null and status != ''" > and a.status = #{status}</if>
           <if test="ordercode != null and ordercode != ''" > and a.ordercode like '%${ordercode}%'</if>
           <if test="username != null and username != ''" > and c.realname like  '%${username}%'</if>
           <if test="barbername != null and barbername != ''" > and b.name like  '%${barbername}%'</if>
           <if test="starttime != null and starttime != ''"> and a.scheduledate &gt;= str_to_date(#{starttime},'%Y-%m-%d %H:%i')</if>
           <if test="endtime != null and endtime != ''"> and a.scheduledate &lt;= str_to_date(#{endtime},'%Y-%m-%d %H:%i')</if>
    </select>
     
     <update id="autofinishOrder">
       update t_lffw_order set status = 3 where paystatus = 1  and  status = 2 and now() > date_add(paytime, interval 5 hour)
     </update>
	

</mapper>