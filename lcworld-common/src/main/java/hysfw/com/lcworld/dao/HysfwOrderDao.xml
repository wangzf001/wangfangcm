<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lcworld.dao.HysfwOrderDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.lcworld.entity.HysfwOrderEntity" id="hysfwOrderMap">
        <result property="id" column="id"/>
        <result property="roomid" column="roomid"/>
        <result property="equipmentids" column="equipmentids"/>
        <result property="serviceids" column="serviceids"/>
        <result property="conferencetype" column="conferencetype"/>
        <result property="conferencename" column="conferencename"/>
        <result property="attendnum" column="attendnum"/>
        <result property="attentdleader" column="attentdleader"/>
        <result property="remark" column="remark"/>
        <result property="imgs" column="imgs"/>
        <result property="imglist" column="imgslist"/>
        <result property="ordercode" column="ordercode"/>
        <result property="uid" column="uid"/>
        <result property="status" column="status"/>
        <result property="reasoncontent" column="reasoncontent"/>
        <result property="checkstatus" column="checkstatus"/>
        <result property="username" column="username"/>
        <result property="mobile" column="mobile"/>
        <result property="createtime" column="createtime"/>
        <result property="failedcontent" column="failedcontent"/>
        <result property="realdel" column="realdel"/>
    </resultMap>

	<select id="queryObject" resultType="com.lcworld.entity.HysfwOrderEntity">
		SELECT
			o.*, tt.typename conferencetypename
		FROM
			t_hysfw_order o
		LEFT JOIN t_hysfw_conference_type tt ON tt.id = o.conferencetype
		WHERE
			o.id = #{value}
	</select>

	<select id="queryList" resultType="com.lcworld.entity.HysfwOrderEntity">
		SELECT
			o.*,o.imgs imglist, (
				SELECT
					GROUP_CONCAT(s.`name`)
				FROM
					t_hysfw_conference_service s
				WHERE
					FIND_IN_SET(s.id, o.serviceids)
			) serviceListStr,
			(
				SELECT
					GROUP_CONCAT(e.`name`)
				FROM
					t_hysfw_conference_equipment e
				WHERE
					FIND_IN_SET(e.id, o.equipmentids)
			) equipmentListStr,
		room.name roomname,
		tt.typename conferencetypename
		FROM
			t_hysfw_order o inner JOIN  t_hysfw_conference_room room ON room.id = o.roomid
			LEFT JOIN t_hysfw_conference_type tt ON tt.id = o.conferencetype
		<where>
			<if test="uid!=null">o.uid = #{uid}</if>
			<if test="orderStatus!=null and orderStatus!=3">AND o.status = #{orderStatus}</if>
			<if test="orderStatus==3">AND o.status in (3,4) </if>
			<if test="checkstatus!=null">AND o.checkstatus = #{checkstatus} </if>
			<if test="oid!=null">AND o.id = #{oid}</if>
			<if test="ordercode!=null and ordercode.trim()!=''">AND o.ordercode like concat("%",#{ordercode},"%")</if>
			<if test="realname!=null and realname.trim()!=''">AND o.username like concat("%",#{realname},"%")</if>
			<if test="mobile!=null and mobile.trim()!=''">AND o.mobile like concat("%",#{mobile},"%")</if>
			<if test="createTimeStart!=null and createTimeStart.trim()!=''">AND o.createtime &gt;= #{createTimeStart}</if>
			<if test="createTimeEnd!=null and createTimeEnd.trim()!=''">AND o.createtime &lt;= #{createTimeEnd}</if>
		</where>
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
			<otherwise>
                order by id desc
			</otherwise>
        </choose>
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>
	
 	<select id="queryTotal" resultType="int">
		select count(*) from t_hysfw_order o
		<where>
			<if test="uid!=null">o.uid = #{uid}</if>
			<if test="orderStatus!=null">AND o.status = #{orderStatus}</if>
			<if test="oid!=null">AND o.id = #{oid}</if>
			<if test="ordercode!=null and ordercode.trim()!=''">AND o.ordercode like concat("%",#{ordercode},"%")</if>
			<if test="realname!=null and realname.trim()!=''">AND o.username like concat("%",#{realname},"%")</if>
			<if test="mobile!=null and mobile.trim()!=''">AND o.mobile like concat("%",#{mobile},"%")</if>
			<if test="createTimeStart!=null and createTimeStart.trim()!=''">AND o.createtime &gt;= #{createTimeStart}</if>
			<if test="createTimeEnd!=null and createTimeEnd.trim()!=''">AND o.createtime &lt;= #{createTimeEnd}</if>
		</where>
	</select>
	 
	<insert id="save" parameterType="com.lcworld.entity.HysfwOrderEntity">
		insert into t_hysfw_order
		(
			`id`, 
			`roomid`, 
			`equipmentids`, 
			`serviceids`, 
			`conferencetype`, 
			`conferencename`, 
			`attendnum`, 
			`attentdleader`, 
			`remark`, 
			`imgs`, 
			`ordercode`, 
			`uid`, 
			`status`, 
			`reasoncontent`, 
			`checkstatus`, 
			`username`, 
			`mobile`, 
			`createtime`, 
			`failedcontent`,
			`realdel`
		)
		values
		(
			#{id}, 
			#{roomid}, 
			#{equipmentids}, 
			#{serviceids}, 
			#{conferencetype}, 
			#{conferencename}, 
			#{attendnum}, 
			#{attentdleader}, 
			#{remark}, 
			#{imgs}, 
			#{ordercode}, 
			#{uid}, 
			#{status}, 
			#{reasoncontent}, 
			#{checkstatus}, 
			#{username}, 
			#{mobile}, 
			#{createtime}, 
			#{failedcontent},
			#{realdel}
		)
	</insert>
	 
	<update id="update" parameterType="com.lcworld.entity.HysfwOrderEntity">
		update t_hysfw_order 
		<set>
			<if test="roomid != null">`roomid` = #{roomid}, </if>
			<if test="equipmentids != null">`equipmentids` = #{equipmentids}, </if>
			<if test="serviceids != null">`serviceids` = #{serviceids}, </if>
			<if test="conferencetype != null">`conferencetype` = #{conferencetype}, </if>
			<if test="conferencename != null">`conferencename` = #{conferencename}, </if>
			<if test="attendnum != null">`attendnum` = #{attendnum}, </if>
			<if test="attentdleader != null">`attentdleader` = #{attentdleader}, </if>
			<if test="remark != null">`remark` = #{remark}, </if>
			<if test="imgs != null">`imgs` = #{imgs}, </if>
			<if test="ordercode != null">`ordercode` = #{ordercode}, </if>
			<if test="uid != null">`uid` = #{uid}, </if>
			<if test="status != null">`status` = #{status}, </if>
			<if test="reasoncontent != null">`reasoncontent` = #{reasoncontent}, </if>
			<if test="checkstatus != null">`checkstatus` = #{checkstatus}, </if>
			<if test="username != null">`username` = #{username}, </if>
			<if test="mobile != null">`mobile` = #{mobile}, </if>
			<if test="createtime != null">`createtime` = #{createtime}, </if>
			<if test="failedcontent != null">`failedcontent` = #{failedcontent},</if>
			<if test="realdel != null">`realdel` = #{realdel}</if>
		</set>
		where id = #{id}
	</update>
	<update id="invalidOrderBatch" parameterType="java.util.Map">
		update t_hysfw_order
		<set>
			<if test="orderStatus != null">`status` = #{orderStatus}</if>
		</set>
		where id in 
		<foreach item="id" collection="ids" open="(" separator="," close=")">
			#{id}
		</foreach>
		and `status` = #{orderStatusFormer}
	</update>
	<delete id="delete">
		delete from t_hysfw_order where id = #{value}
	</delete>
	
	<delete id="deleteBatch">
		delete from t_hysfw_order where id in 
		<foreach item="id" collection="array" open="(" separator="," close=")">
			#{id}
		</foreach>
	</delete>
	<select id="queryOrderlist" resultType="com.lcworld.dto.HysfwOrderDTO">
		SELECT
			a.id,
			a.ordercode,
			a.createtime,
			a.conferencename,
			a.attentdleader,
			a.conferencetype,
			a.attendnum,
			a.equipmentids,
			a.imgs,
			a.`status`,
			b.date
		FROM
		<choose>
			<when test="orderstatus == 5">
			t_hysfw_order_cancel thoc
			INNER JOIN t_hysfw_order a on thoc.order_id=a.id
			</when>
			<otherwise>
				<choose>
					<when test="orderstatus == 1">
						t_hysfw_order a
					</when>
					<otherwise>
						t_delivery_order tdo
						INNER JOIN t_hysfw_order a ON tdo.orderid = a.id
					</otherwise>
				</choose>
			</otherwise>
		</choose>
		
		LEFT JOIN t_hysfw_appointment b ON a.id = b.orderid
		WHERE
			1=1
        
        <choose>
        	<when test="orderstatus == 5">
        	AND thoc.menderid=#{uid}
        	</when>
        	<otherwise>
        	
	        	<choose>
	        		<when test="orderstatus == 1">
					AND a.status = #{orderstatus}
	        		AND a.id not in (select order_id from t_hysfw_order_refuse where menderid=#{uid})
	        		</when>
	        		<otherwise>
					AND tdo.did =  #{uid}
	        		AND tdo.ordertype = 7
					AND tdo.status = #{orderstatus}
	        		</otherwise>
	        	</choose>
			
        	</otherwise>
        </choose>
         and a.realdel = 0 
         <!-- and a.checkstatus = 2 -->
        
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
            <otherwise>
                order by a.id desc
            </otherwise>
        </choose>
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>
    </select>
	
	<select id="queryOrderDetail" resultType="com.lcworld.dto.HysfwOrderDTO">
		SELECT
			a.id,
			a.ordercode,
			a.createtime,
			a.conferencename,
			a.attentdleader,
			a.conferencetype,
			a.attendnum,
			a.equipmentids,
			a.imgs,
			a.`status`,
			a.username,
			a.mobile,
			a.remark,
			b.date
		FROM
			t_hysfw_order a
		LEFT JOIN t_hysfw_appointment b ON a.id = b.orderid
		WHERE
			a.id = #{orderid}
    </select>
    
    <insert id="saveOrderCancel">
    	insert into t_hysfw_order_cancel(order_id,menderid,cancel_time,cancel_reason)
    	values (#{order_id},#{menderid},#{cancel_time},#{cancel_reason})
    </insert>
    
    <insert id="refuseOrder">
    	insert into t_hysfw_order_refuse(menderid,order_id)
    	values (#{uid},#{orderId})
    	
    </insert>
    
    <delete id="deleteDeliveryOrder">
    	delete from t_delivery_order where did=#{menderid} and orderid=#{order_id} and ordertype=7
    </delete>
    
    <update id="finishDeliveryOrders">
    	update t_delivery_order set status=3 where did=#{uid} and orderid=#{id} and ordertype=7
    </update>
    
    <delete id="deleteCancelOrder">
    	delete from t_hysfw_order_cancel where order_id=#{id} and menderid=#{menderid}
    </delete>
    
    <update id="deleteOverOrder">
    	update t_hysfw_order set realdel = 1 where id=#{orderId}
    </update>
    
</mapper>