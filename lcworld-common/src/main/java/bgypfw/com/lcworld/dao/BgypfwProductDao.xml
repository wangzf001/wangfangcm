<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lcworld.dao.BgypfwProductDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.lcworld.entity.BgypfwProductEntity" id="bgypfwProductMap">
        <result property="id" column="id"/>
        <result property="productname" column="productname"/>
        <result property="pricerange" column="pricerange"/>
        <result property="createtime" column="createtime"/>
        <result property="mainskuid" column="mainskuid"/>
        <result property="status" column="status"/>
        <result property="onsaleTime" column="onsale_time"/>
        <result property="categoryOneId" column="category_one_id"/>
        <result property="categoryTwoId" column="category_two_id"/>
        <result property="favorNum" column="favor_num"/>
        <result property="supplierName" column="supplier_name"/>
        <result property="supplierInfo" column="supplier_info"/>
        <result property="productCode" column="product_code"/>
        <result property="productImg" column="productImg"/>
        <result property="price" column="price"/>
        <result property="categoryOneName" column="categoryOneName"/>
        <result property="categoryTwoName" column="categoryTwoName"/>
        <collection property="imgEntityList" javaType="com.lcworld.entity.BgypfwProductimgEntity">
            <id property="id" column="imgId"/>
            <result property="productId" column="product_id"/>
            <result property="img" column="img"/>
            <result property="sort" column="sort"/>
        </collection>
    </resultMap>

    <select id="queryObject" resultMap="bgypfwProductMap">
		select *,i.id imgId,(SELECT s.price FROM t_bgypfw_skuid s WHERE s.id = p.mainskuid) price
		from t_bgypfw_product p
		left join t_bgypfw_productimg i on i.product_id = p.id
		where p.id = #{value}
	</select>
    <select id="queryProductByName" resultType="com.lcworld.entity.BgypfwProductEntity">
		select * from t_bgypfw_product where locate(#{value},productname)>0
	</select>

    <select id="queryList" resultMap="bgypfwProductMap">
        select p.*,s.mainimg productImg,s.price price,
        (SELECT cname FROM t_bgypfw_category c WHERE c.id = p.category_one_id) categoryOneName,
        (SELECT cname FROM t_bgypfw_category c WHERE c.id = p.category_two_id) categoryTwoName,
        i.id imgId,i.*
        from t_bgypfw_product p
        left join t_bgypfw_skuid s on s.id = p.mainskuid
        left join t_bgypfw_productimg i on i.product_id = p.id
        <if test="favorstatus!=null">
            LEFT JOIN t_favor f ON f.entityid = p.id
        </if>
        <where>
            <if test="ids!=null">p.id in
                <foreach item="id" collection="ids" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>
            <if test="categoryOneId!=null">p.category_one_id = #{categoryOneId}</if>
            <if test="categoryTwoId!=null">and p.category_two_id = #{categoryTwoId}</if>
            <if test="status!=null">and p.status = #{status}</if>
            <if test="keyword!=null and keyword.trim()!=''">and p.productname like concat('%',#{keyword},'%') or
                p.supplier_name like concat('%',#{keyword},'%') or p.product_code like concat('%',#{keyword},'%')
            </if>
            <if test="maxprice!=null and maxprice.trim()!=''">and (SELECT MIN(sku.price) FROM t_bgypfw_skuid sku WHERE
                sku.productid = p.id) &lt;= #{maxprice}
            </if>
            <if test="minprice!=null and minprice.trim()!=''">and (SELECT MAX(sku.price) FROM t_bgypfw_skuid sku WHERE
                sku.productid = p.id) &gt;= #{minprice}
            </if>
            <if test="createTimeStart!=null and createTimeStart.trim()!=''">and p.createtime &gt;= #{createTimeStart}
            </if>
            <if test="createTimeEnd!=null and createTimeEnd.trim()!=''">and p.createtime &lt;= #{createTimeEnd}</if>
            <if test="favorstatus != null and favortype != null and favoruid!=null">
                AND f.favortype = #{favortype} AND f.uid = #{favoruid} AND f.`status` = #{favorstatus}
            </if>
        </where>
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
            <otherwise>
                order by p.id desc
            </otherwise>
        </choose>
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>
    </select>

    <select id="queryTotal" resultType="int">
        select count(*) from t_bgypfw_product p
        <where>
            <if test="categoryOneId!=null">p.category_one_id = #{categoryOneId}</if>
            <if test="categoryTwoId!=null">and p.category_two_id = #{categoryTwoId}</if>
            <if test="status!=null">and p.status = #{status}</if>
            <if test="keyword!=null and keyword.trim()!=''">and p.productname like concat('%',#{keyword},'%') or
                p.supplier_name like concat('%',#{keyword},'%') or p.product_code like concat('%',#{keyword},'%')
            </if>
            <if test="minprice!=null and minprice.trim()!=''">and (SELECT MIN(sku.price) FROM t_bgypfw_skuid sku WHERE
                sku.productid = p.id) &lt;= #{maxprice}
            </if>
            <if test="maxprice!=null and maxprice.trim()!=''">and (SELECT MAX(sku.price) FROM t_bgypfw_skuid sku WHERE
                sku.productid = p.id) &gt;= #{minprice}
            </if>
            <if test="createTimeStart!=null and createTimeStart.trim()!=''">and p.createtime &gt;= #{createTimeStart}
            </if>
            <if test="createTimeEnd!=null and createTimeEnd.trim()!=''">and p.createtime &lt;= #{createTimeEnd}</if>
        </where>
    </select>

    <insert id="save" parameterType="com.lcworld.entity.BgypfwProductEntity" useGeneratedKeys="true" keyProperty="id">
		insert into t_bgypfw_product
		(
			`productname`, 
			`pricerange`, 
			`createtime`, 
			`mainskuid`, 
			`status`, 
			`onsale_time`,
			`category_one_id`,
			`category_two_id`,
			`favor_num`,
			`product_code`
		)
		values
		(
			#{productname}, 
			#{pricerange}, 
			#{createtime}, 
			#{mainskuid}, 
			#{status}, 
			#{onsaleTime},
			#{categoryOneId},
			#{categoryTwoId},
			#{favorNum},
			#{productCode}
		)
	</insert>
    <insert id="saveBatch" parameterType="java.util.List">
        insert into t_bgypfw_product
        (
        `productname`,
        `pricerange`,
        `createtime`,
        `mainskuid`,
        `status`,
        `onsale_time`,
        `category_one_id`,
        `category_two_id`,
        `favor_num`,
        `product_code`
        )
        values
        <foreach item="item" collection="list" separator=",">
            (
            #{item.productname},
            #{item.pricerange},
            #{item.createtime},
            #{item.mainskuid},
            #{item.status},
            #{item.onsaleTime},
            #{item.categoryOneId},
            #{item.categoryTwoId},
            #{item.favorNum},
            #{item.productCode}
            )
        </foreach>
    </insert>
    <update id="update" parameterType="com.lcworld.entity.BgypfwProductEntity">
        update t_bgypfw_product
        <set>
            <if test="productname != null">`productname` = #{productname},</if>
            <if test="pricerange != null">`pricerange` = #{pricerange},</if>
            <if test="createtime != null">`createtime` = #{createtime},</if>
            <if test="mainskuid != null">`mainskuid` = #{mainskuid},</if>
            <if test="status != null">`status` = #{status},</if>
            <if test="onsaleTime != null">`onsale_time` = #{onsaleTime},</if>
            <if test="categoryOneId != null">`category_one_id` = #{categoryOneId},</if>
            <if test="categoryTwoId != null">`category_two_id` = #{categoryTwoId},</if>
            <if test="favorNum != null">`favor_num` = #{favorNum},</if>
            <if test="supplierName != null">`supplier_name` = #{supplierName},</if>
            <if test="supplierInfo != null">`supplier_info` = #{supplierInfo},</if>
            <if test="productCode != null">`product_code` = #{productCode}</if>
        </set>
        where id = #{id}
    </update>

    <delete id="delete">
		delete from t_bgypfw_product where id = #{value}
	</delete>

    <delete id="deleteBatch">
        delete from t_bgypfw_product where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

</mapper>