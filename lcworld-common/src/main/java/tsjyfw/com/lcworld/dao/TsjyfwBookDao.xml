<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lcworld.dao.TsjyfwBookDao">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.lcworld.entity.TsjyfwBookEntity" id="tsjyfwBookMap">
        <result property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="author" column="author"/>
        <result property="publisher" column="publisher"/>
        <result property="authorbrief" column="authorbrief"/>
        <result property="createtime" column="createtime"/>
        <result property="img" column="img"/>
        <result property="brief" column="brief"/>
        <result property="typeid" column="typeid"/>
        <result property="bollowstatus" column="bollowstatus"/>
        <result property="score" column="score"/>
        <result property="shortbrief" column="shortbrief"/>
        <result property="content" column="content"/>
        <result property="url" column="url"/>
        <result property="favorcount" column="favorcount"/>
        <result property="borrowcount" column="borrowcount"/>
        <result property="isdel" column="isdel"/>
        <result property="isbn" column="isbn"/>
        <result property="searchid" column="searchid"/>
        <result property="barcode" column="barcode"/>
        <result property="keyword" column="keyword"/>
        <result property="subtitle" column="subtitle"/>
    </resultMap>

    <select id="queryObject" resultType="com.lcworld.entity.TsjyfwBookEntity">
        select * from t_tsjyfw_book where id = #{value}
    </select>

    <select id="queryList" resultType="com.lcworld.entity.TsjyfwBookEntity">
       SELECT
           a.id,
            a.title,
            a.author,
            a.publisher,
            a.authorbrief,
            a.createtime,
            a.img,
            a.brief,
            a.typeid,
            a.score,
            a.shortbrief,
            a.content,
            a.url,
            a.favorcount,
            a.isdel,
            a.isbn,
            a.barcode,
            a.keyword,
            a.subtitle,
            a.store,
            a.remain,
            a.borrowcount,
            a.bollowstatus
        FROM
            t_tsjyfw_book a
  <if test="favorstatus!=null">
            LEFT JOIN t_favor f ON f.entityid = a.id 
        </if>
        LEFT JOIN t_tsjyfw_book_ordercount_view b ON a.id = b.bookid
        WHERE
            1 = 1
       
        
        <if test="typeid != null and typeid != ''">
            and a.typeid = #{typeid}
        </if>
       
        
        <if test="type == 0 ">
            and (
             a.searchid like '%${searchid}%'
            or a.barcode like '%${barcode}%'
            or a.author like '%${author}%'
            or a.publisher like '%${publisher}%'
            or a.title like '%${title}%'
            or a.isbn like '%${isbn}%'
            or a.keyword like '%${keyword}%'
            or a.subtitle like '%${subtitle}%'
            )
        </if>
        <if test="type != 0 and (searchid != null and searchid != '')">
            and a.searchid like '%${searchid}%'
        </if>
        <if test="type != 0 and (barcode != null and barcode != '')">
            and a.barcode like '%${barcode}%'
        </if>
        <if test="type != 0 and (author != null and author != '')">
            and a.author like '%${author}%'
        </if>
        <if test="type != 0 and (publisher != null and publisher != '')">
            and a.publisher like '%${publisher}%'
        </if>
        <if test="type != 0 and (title != null and title != '')">
            and a.title like '%${title}%'
        </if>
        <if test="type != 0 and (isbn != null and isbn != '')">
            and a.isbn like '%${isbn}%'
        </if>
         <if test="type != 0 and (keywords != null and keywords != '')">
            and a.keyword like '%${keywords}%'
        </if>
        <if test="type != 0 and (subtitle != null and subtitle != '')">
            and a.subtitle like '%${subtitle}%'
        </if>
          <if test="bookidlist != null and bookidlist.size> 0">
             and b.id in 
        <foreach item="id" collection="bookidlist" open="(" separator="," close=")">
            #{id}
        </foreach>
        </if>
        <if test="favorstatus != null and favortype != null and favoruid!=null">
            AND f.favortype = #{favortype} AND f.uid = #{favoruid} AND f.`status` = #{favorstatus}
        </if>
        
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>
    </select>
    
    <select id="queryTotal" resultType="int">
        SELECT
           count(*)
        FROM
            t_tsjyfw_book a
  <if test="favorstatus!=null">
            LEFT JOIN t_favor f ON f.entityid = a.id 
        </if>
        LEFT JOIN t_tsjyfw_book_ordercount_view b ON a.id = b.bookid
        WHERE
            1 = 1
        
        
        <if test="typeid != null and typeid != ''">
            and a.typeid = #{typeid}
        </if>
       
        <if test="type == 0 ">
            and (
             a.searchid like '%${searchid}%'
            or a.barcode like '%${barcode}%'
            or a.author like '%${author}%'
            or a.publisher like '%${publisher}%'
            or a.title like '%${title}%'
            or a.isbn like '%${isbn}%'
            or a.keyword like '%${keyword}%'
            or a.subtitle like '%${subtitle}%'
            )
        </if>
        <if test="type != 0 and (searchid != null and searchid != '')">
            and a.searchid like '%${searchid}%'
        </if>
        <if test="type != 0 and (barcode != null and barcode != '')">
            and a.barcode like '%${barcode}%'
        </if>
        <if test="type != 0 and (author != null and author != '')">
            and a.author like '%${author}%'
        </if>
        <if test="type != 0 and (publisher != null and publisher != '')">
            and a.publisher like '%${publisher}%'
        </if>
        <if test="type != 0 and (title != null and title != '')">
            and a.title like '%${title}%'
        </if>
        <if test="type != 0 and (isbn != null and isbn != '')">
            and a.isbn like '%${isbn}%'
        </if>
         <if test="type != 0 and (keywords != null and keywords != '')">
            and a.keyword like '%${keywords}%'
        </if>
        <if test="type != 0 and (subtitle != null and subtitle != '')">
            and a.subtitle like '%${subtitle}%'
        </if>
          <if test="bookidlist != null and bookidlist.size> 0">
             and b.id in 
        <foreach item="id" collection="bookidlist" open="(" separator="," close=")">
            #{id}
        </foreach>
        </if>
        <if test="favorstatus != null and favortype != null and favoruid!=null">
            AND f.favortype = #{favortype} AND f.uid = #{favoruid} AND f.`status` = #{favorstatus}
        </if>
       
       
    </select>
     
    <insert id="save" parameterType="com.lcworld.entity.TsjyfwBookEntity" useGeneratedKeys="true" keyProperty="id">
        insert into t_tsjyfw_book
        (
            `title`, 
            `author`, 
            `publisher`, 
            `authorbrief`, 
            `createtime`, 
            `img`, 
            `brief`, 
            `typeid`, 
            `bollowstatus`, 
            `score`, 
            `shortbrief`, 
            `content`, 
            `url`, 
            `favorcount`, 
            `borrowcount`, 
            `isdel`,
            `isbn`,
            `keyword`,
            `subtitle`
        )
        values
        (
            #{title}, 
            #{author}, 
            #{publisher}, 
            #{authorbrief}, 
            #{createtime}, 
            #{img}, 
            #{brief}, 
            #{typeid}, 
            #{bollowstatus}, 
            #{score}, 
            #{shortbrief}, 
            #{content}, 
            #{url}, 
            #{favorcount}, 
            #{borrowcount}, 
            #{isdel},
            #{isbn},
            #{keyword},
            #{subtitle}
            
        )
    </insert>
     
    <update id="update" parameterType="com.lcworld.entity.TsjyfwBookEntity">
        update t_tsjyfw_book 
        <set>
            <if test="title != null">`title` = #{title}, </if>
            <if test="author != null">`author` = #{author}, </if>
            <if test="publisher != null">`publisher` = #{publisher}, </if>
            <if test="authorbrief != null">`authorbrief` = #{authorbrief}, </if>
            <if test="createtime != null">`createtime` = #{createtime}, </if>
            <if test="img != null">`img` = #{img}, </if>
            <if test="brief != null">`brief` = #{brief}, </if>
            <if test="typeid != null">`typeid` = #{typeid}, </if>
            <if test="bollowstatus != null">`bollowstatus` = #{bollowstatus}, </if>
            <if test="score != null">`score` = #{score}, </if>
            <if test="shortbrief != null">`shortbrief` = #{shortbrief}, </if>
            <if test="content != null">`content` = #{content}, </if>
            <if test="url != null">`url` = #{url}, </if>
            <if test="favorcount != null">`favorcount` = #{favorcount}, </if>
            <if test="borrowcount != null">`borrowcount` = #{borrowcount}, </if>
            <if test="isdel != null">`isdel` = #{isdel},</if>
            <if test="isbn != null">`isbn` = #{isbn},</if>
            <if test="keyword != null">`keyword` = #{keyword},</if>
            <if test="searchid != null">`searchid` = #{searchid},</if>
            <if test="barcode != null">`barcode` = #{barcode},</if>
            <if test="subtitle != null">`subtitle` = #{subtitle}</if>
        </set>
        where id = #{id}
    </update>
    
    <delete id="delete">
        delete from t_tsjyfw_book where id = #{value}
    </delete>
    
    <delete id="deleteBatch">
        delete from t_tsjyfw_book where id in 
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    
    <select id="queryBookList" resultType="com.lcworld.dto.TsjyfwBookDTO">
        SELECT
		    a.id,
		    a.title,
		    a.author,
		    a.publisher,
		    a.authorbrief,
		    a.createtime,
		    a.img,
		    a.brief,
		    a.typeid,
		    a.score,
		    a.shortbrief,
		    a.content,
		    a.url,
		    a.favorcount,
		    a.isdel,
		    a.isbn,
		    a.barcode,
		    a.keyword,
		    a.subtitle,
		    a.store,
		    a.remain,
		    a.borrowcount,
		     a.bollowstatus
		FROM
		    t_tsjyfw_book a
		LEFT JOIN t_tsjyfw_book_ordercount_view b ON a.id = b.bookid
		WHERE
		    1 = 1
		AND a.isdel = 0
        
        
        <if test="typeid != null and typeid != ''">
            and a.typeid = #{typeid}
        </if>
    
        
        <if test="type == 0 ">
            and (
             a.searchid like '%${searchid}%'
            or a.barcode like '%${barcode}%'
            or a.author like '%${author}%'
            or a.publisher like '%${publisher}%'
            or a.title like '%${title}%'
            or a.isbn like '%${isbn}%'
            or a.keyword like '%${keyword}%'
            or a.subtitle like '%${subtitle}%'
            )
        </if>
        <if test="type != 0 and (searchid != null and searchid != '')">
            and a.searchid like '%${searchid}%'
        </if>
        <if test="type != 0 and (barcode != null and barcode != '')">
            and a.barcode like '%${barcode}%'
        </if>
        <if test="type != 0 and (author != null and author != '')">
            and a.author like '%${author}%'
        </if>
        <if test="type != 0 and (publisher != null and publisher != '')">
            and a.publisher like '%${publisher}%'
        </if>
        <if test="type != 0 and (title != null and title != '')">
            and a.title like '%${title}%'
        </if>
        <if test="type != 0 and (isbn != null and isbn != '')">
            and a.isbn like '%${isbn}%'
        </if>
         <if test="type != 0 and (keywords != null and keywords != '')">
            and a.keyword like '%${keywords}%'
        </if>
        <if test="type != 0 and (subtitle != null and subtitle != '')">
            and a.subtitle like '%${subtitle}%'
        </if>
         <if test="order != null">
             <choose>
                <when test="order == 1">
                    order by a.createtime desc
                </when>
                <when test="order == 2">
                    order by a.favorcount+b.count desc
                </when>
                <when test="order == 3">
                    order by a.score desc
                </when>
                <otherwise>
                    order by a.id desc
                </otherwise>
            </choose>
         </if>
       
       
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>
    </select>
    
    <update id="saveaAddOrderCountBench" parameterType="java.util.List">
        update t_tsjyfw_book  set borrowcount =borrowcount+1,bollowstatus=2 where 1=1 
        and id in 
        <foreach item="id" collection="list" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    
    <select id="queryUnBorrowCopyList" resultType="com.lcworld.entity.TsjyfwBookCopyEntity">
        select a.*,b.title bookname from t_tsjyfw_book b INNER JOIN
			t_tsjyfw_book_copy a on a.bookid = b.id 
			where a.borrowstatus=1
 
       
        <if test="bookidlist != null and bookidlist.size> 0">
             and a.bookid in 
        <foreach item="id" collection="bookidlist" open="(" separator="," close=")">
            #{id}
        </foreach>
        </if>
       
     
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>
    </select>
    
    <select id="queryUnBorrowBookList" resultType="com.lcworld.entity.TsjyfwBookEntity">
        select a.* from t_tsjyfw_book a
			where a.bollowstatus=1
 
       
        <if test="bookidlist != null and bookidlist.size> 0">
             and a.id in 
        <foreach item="id" collection="bookidlist" open="(" separator="," close=")">
            #{id}
        </foreach>
        </if>
       
     
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>
    </select>

</mapper>