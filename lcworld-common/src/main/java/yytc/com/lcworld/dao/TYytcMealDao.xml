<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lcworld.dao.TYytcMealDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.lcworld.entity.TYytcMealEntity" id="tYytcMealMap">
        <result property="mId" column="m_id"/>
        <result property="mTitle" column="m_title"/>
        <result property="mCreateTime" column="m_create_time"/>
        <result property="mSource" column="m_source"/>
        <result property="mType" column="m_type"/>
        <result property="mImg" column="m_img"/>
        <result property="mContent" column="m_content"/>
        <result property="mScanNum" column="m_scan_num"/>
        <result property="mPraiseNum" column="m_praise_num"/>
        <result property="mFavorNum" column="m_favor_num"/>
        <result property="mCalories" column="m_calories"/>
        <result property="mTimeType" column="m_time_type"/>
        <result property="mRecommend" column="m_recommend"/>
        <result property="mUrl" column="m_url"/>
        <result property="mConsumeWay" column="m_consume_way"/>
        <result property="mHealthyFunction" column="m_healthy_function"/>
        <collection property="ingredientList" javaType="com.lcworld.entity.TYytcIngredientEntity"  >
        	<id property="iId" column="i_id" />
	        <result property="iNameNum" column="i_name_num"/>
        </collection>
        <collection property="stepList" javaType="com.lcworld.entity.TYytcStepEntity">
        	<id property="sId" column="s_id" />
	        <result property="sContent" column="s_content"/>
	        <result property="sImg" column="s_img"/>
	        <result property="sSort" column="s_sort"/>
        </collection>
    </resultMap>

	<select id="queryObject" resultMap="tYytcMealMap">
		select * from t_yytc_meal m 
		left join t_yytc_ingredient i on i.m_id = m.m_id
		left join t_yytc_step s on s.m_id = m.m_id
		where m.m_id = #{value}
	</select>

	<select id="queryList" resultType="com.lcworld.entity.TYytcMealEntity">
		select m.*,
			GROUP_CONCAT(DISTINCT CONCAT("step",s.s_sort,":",s.s_content)) stepStr,
			GROUP_CONCAT(DISTINCT i.i_name_num) ingredientStr
		from t_yytc_meal m
		left join t_yytc_ingredient i on i.m_id = m.m_id
		left join t_yytc_step s on s.m_id = m.m_id
		<where>
			<if test="ids!=null">m.m_id in 
				<foreach item="id" collection="ids" open="(" separator="," close=")">
					#{id}
				</foreach>
			</if>
			<if test="type!=null">m.m_type = #{type}</if>
			<if test="timeType!=null">and m.m_time_type = #{timeType}</if>
			<if test="keyword!=null and keyword.trim()!=''">and (m.m_title like concat('%',#{keyword},'%') or m.m_content like concat('%',#{keyword},'%'))</if>
		</where>
		GROUP BY m.m_id
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
			<otherwise>
                order by m.m_id desc
			</otherwise>
        </choose>
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>
	
 	<select id="queryTotal" resultType="int">
		select count(*) from t_yytc_meal m
		<where>
			<if test="type!=null">m.m_type = #{type}</if>
			<if test="timeType!=null">and m.m_time_type = #{timeType}</if>
			<if test="keyword!=null and keyword.trim()!=''">and (m.m_title like concat('%',#{keyword},'%') or m.m_content like concat('%',#{keyword},'%'))</if>
		</where>
	</select>
	 
	<insert id="save" parameterType="com.lcworld.entity.TYytcMealEntity" useGeneratedKeys="true" keyProperty="mId">
		insert into t_yytc_meal
		(
			`m_title`, 
			`m_create_time`, 
			`m_source`, 
			`m_type`, 
			`m_img`, 
			`m_content`, 
			`m_scan_num`, 
			`m_praise_num`, 
			`m_favor_num`, 
			`m_calories`,
			`m_time_type`,
			`m_recommend`,
			`m_url`,
			`m_consume_way`,
			`m_healthy_function`
		)
		values
		(
			#{mTitle}, 
			#{mCreateTime}, 
			#{mSource}, 
			#{mType}, 
			#{mImg}, 
			#{mContent}, 
			#{mScanNum}, 
			#{mPraiseNum}, 
			#{mFavorNum}, 
			#{mCalories},
			#{mTimeType},
			#{mRecommend},
			#{mUrl},
			#{mConsumeWay},
			#{mHealthyFunction}
		)
	</insert>
	<insert id="saveBatch" parameterType="java.util.List">
       insert into t_yytc_meal
		(
			`m_title`, 
			`m_create_time`, 
			`m_source`, 
			`m_type`, 
			`m_img`, 
			`m_content`, 
			`m_scan_num`, 
			`m_praise_num`, 
			`m_favor_num`, 
			`m_calories`,
			`m_time_type`,
			`m_recommend`,
			`m_url`,
			`m_consume_way`,
			`m_healthy_function`
		)
		values
        <foreach collection="list" item="item" index="index"
            separator=",">
       (
			#{item.mTitle}, 
			#{item.mCreateTime}, 
			#{item.mSource}, 
			#{item.mType}, 
			#{item.mImg}, 
			#{item.mContent}, 
			#{item.mScanNum}, 
			#{item.mPraiseNum}, 
			#{item.mFavorNum}, 
			#{item.mCalories},
			#{item.mTimeType},
			#{item.mRecommend},
			#{item.mUrl},
			#{item.mConsumeWay},
			#{item.mHealthyFunction}
		)
        </foreach>
    </insert>
	<update id="recommend" parameterType="Integer[]">
		update t_yytc_meal 
		<set>
			`m_recommend` = ABS(IFNULL(`m_recommend`,0)-1)
		</set>
		where m_id in
		<foreach item="mId" collection="array" open="(" separator="," close=")">
			#{mId}
		</foreach> 
	</update>
	<update id="update" parameterType="com.lcworld.entity.TYytcMealEntity">
		update t_yytc_meal 
		<set>
			<if test="mTitle != null">`m_title` = #{mTitle}, </if>
			<if test="mCreateTime != null">`m_create_time` = #{mCreateTime}, </if>
			<if test="mSource != null">`m_source` = #{mSource}, </if>
			<if test="mType != null">`m_type` = #{mType}, </if>
			<if test="mImg != null">`m_img` = #{mImg}, </if>
			<if test="mContent != null">`m_content` = #{mContent}, </if>
			<if test="mScanNum != null">`m_scan_num` = #{mScanNum}, </if>
			<if test="mPraiseNum != null">`m_praise_num` = #{mPraiseNum}, </if>
			<if test="mFavorNum != null">`m_favor_num` = #{mFavorNum}, </if>
			<if test="mCalories != null">`m_calories` = #{mCalories},</if>
			<if test="mTimeType != null">`m_time_type` = #{mTimeType},</if>
			<if test="mRecommend != null">`m_recommend` = #{mRecommend},</if>
			<if test="mUrl != null">`m_url` = #{mUrl},</if>
			<if test="mConsumeWay != null">`m_consume_way` = #{mConsumeWay},</if>
			<if test="mHealthyFunction != null">`m_healthy_function` = #{mHealthyFunction}</if>
		</set>
		where m_id = #{mId}
	</update>
	
	<delete id="delete">
		delete from t_yytc_meal where m_id = #{value}
	</delete>
	
	<delete id="deleteBatch">
		delete from t_yytc_meal where m_id in 
		<foreach item="mId" collection="array" open="(" separator="," close=")">
			#{mId}
		</foreach>
	</delete>

</mapper>