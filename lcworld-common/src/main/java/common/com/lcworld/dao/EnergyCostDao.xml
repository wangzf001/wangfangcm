<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lcworld.dao.EnergyCostDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.lcworld.entity.EnergyCostEntity" id="energyCostMap">
        <result property="eId" column="e_id"/>
        <result property="buildId" column="build_id"/>
        <result property="buildName" column="build_name"/>
        <result property="energyType" column="energy_type"/>
        <result property="energyCost" column="energy_cost"/>
        <result property="creatTime" column="creat_time"/>
    </resultMap>

	<select id="queryObject" resultType="com.lcworld.entity.EnergyCostEntity">
		select * from t_energy_cost where e_id = #{value}
	</select>

	<select id="queryList" resultType="com.lcworld.entity.EnergyCostEntity">
		select * from t_energy_cost
        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
			<otherwise>
                order by e_id desc
			</otherwise>
        </choose>
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>
	
 	<select id="queryTotal" resultType="int">
		select count(*) from t_energy_cost 
	</select>
	 
	<insert id="save" parameterType="com.lcworld.entity.EnergyCostEntity" useGeneratedKeys="true" keyProperty="eId">
		insert into t_energy_cost
		(
			`build_id`, 
			`energy_type`, 
			`energy_cost`, 
			`creat_time`
		)
		values
		(
			#{buildId}, 
			#{energyType}, 
			#{energyCost}, 
			#{creatTime}
		)
	</insert>
	 
	<update id="update" parameterType="com.lcworld.entity.EnergyCostEntity">
		update t_energy_cost 
		<set>
			<if test="buildId != null">`build_id` = #{buildId}, </if>
			<if test="energyType != null">`energy_type` = #{energyType}, </if>
			<if test="energyCost != null">`energy_cost` = #{energyCost}, </if>
			<if test="creatTime != null">`creat_time` = #{creatTime}</if>
		</set>
		where e_id = #{eId}
	</update>
	
	<delete id="delete">
		delete from t_energy_cost where e_id = #{value}
	</delete>
	
	<delete id="deleteBatch">
		delete from t_energy_cost where e_id in 
		<foreach item="eId" collection="array" open="(" separator="," close=")">
			#{eId}
		</foreach>
	</delete>
	
	<!-- 查询出前一天的水耗和电耗 -->
	<select id="bothCostQuery" resultType="Integer">
	SELECT  ifnull(sum(c.energy_cost),0)  
	FROM `t_energy_cost` c  
	where c.energy_type= #{energyType} <!-- 1,电   2，水 -->  
	and c.creat_time = date_sub(curdate(),interval 1 day)
	</select>

	
	<!-- 根据不同条件查询某楼的某年每月或某月每日的消耗统计数据 -->
	<select id="energyCostQuery" resultMap="energyCostMap">
	select  t.build_id ,b.build_name,t.energy_type
	<if test="dateType != null and dateType == 2">
		,t.creat_time  as 'creat_time', SUM(t.energy_cost) as 'energy_cost' 
	</if>
	<if test="dateType != null and dateType == 1">
		,date_format(t.creat_time,'%Y-%m')   as 'creat_time',SUM(t.energy_cost) as 'energy_cost' 
	</if>
		from t_energy_cost t  
		LEFT JOIN t_building b  
		on b.id = t.build_id
		where t.energy_type = #{energyType} <!-- 1,电   2，水 -->
		and b.id = #{bid}
		<if test="dateType != null and dateType == 2"><!--dateType:1，按年 2，按月   -->
			and date_format(t.creat_time,'%Y-%m') = date_format(str_to_date(#{date},'%Y-%m'),'%Y-%m')
			GROUP BY t.creat_time 
			ORDER BY t.creat_time  ASC
		</if>
		<if test="dateType != null and dateType == 1">
			and YEAR(t.creat_time) =  YEAR(str_to_date(#{date},'%Y'))
			GROUP BY MONTH(t.creat_time)
			ORDER BY MONTH(t.creat_time) ASC
		</if>
	</select>
	
	
	<!-- 根据不同条件查询某楼的某年或某月的总消耗数据 -->
	<select id="energyCostTotalQuery" resultMap="energyCostMap">
	select  t.build_id ,b.build_name,t.energy_type
	<if test="dateType != null and dateType == 2">
		,date_format(t.creat_time,'%Y-%m')  as 'creat_time', SUM(t.energy_cost) as 'energy_cost' 
	</if>
	<if test="dateType != null and dateType == 1">
		,YEAR(t.creat_time)  as 'creat_time',SUM(t.energy_cost) as 'energy_cost' 
	</if>
		from t_energy_cost t  
		LEFT JOIN t_building b  
		on b.id = t.build_id
		where t.energy_type = #{energyType} <!-- 1,电   2，水 -->
		and b.id = #{bid}
		<if test="dateType != null and dateType == 2 and date != null and date.trim() != ''"><!--dateType:1，按年 2，按月   -->
		    and date_format(t.creat_time,'%Y-%m') =  date_format(str_to_date(#{date},'%Y-%m'),'%Y-%m')
			ORDER BY MONTH(t.creat_time)  ASC
		</if>
		<if test="dateType != null and dateType == 1 and date != null and date.trim() != ''">
			and YEAR(t.creat_time) = YEAR(str_to_date(#{date},'%Y'))
			ORDER BY YEAR(t.creat_time) ASC
		</if>
	</select>
</mapper>