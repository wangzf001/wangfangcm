<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lcworld.dao.TBxwxOrderDao">

    <resultMap type="com.lcworld.entity.TBxwxOrderEntity" id="tBxwxOrderMap">
        <result property="id" column="id"/>
        <result property="menditem" column="menditem"/>
        <result property="username" column="username"/>
        <result property="mobile" column="mobile"/>
        <result property="invitetime" column="invitetime"/>
        <result property="buildId" column="buildId"/>
        <result property="serviceplace" column="serviceplace"/>
        <result property="menderid" column="menderid"/>
        <result property="mendcontent" column="mendcontent"/>
        <result property="mendimgs" column="mendimgs"/>
        <result property="price" column="price"/>
        <result property="orderstatus" column="orderstatus"/>
        <result property="uid" column="uid"/>
        <result property="createtime" column="createtime"/>
        <result property="invitetimetype" column="invitetimetype"/>
        <result property="orderchange" column="orderchange"/>
        <result property="ordercode" column="ordercode"/>
        <result property="paystatus" column="paystatus"/>
        <result property="isdel" column="isdel"/>
        <result property="paytype" column="paytype"/>
        <result property="cancelreason" column="cancelreason"/>
        <result property="realdel" column="realdel"/>
    </resultMap>

    <select id="queryObject" resultType="com.lcworld.entity.TBxwxOrderEntity">
        select * from t_bxwx_order where id = #{value}
        <!--<where>
         id = #{id}
         <if test="ordercode != null and ordercode != ''" >
             and ordercode = #{ordercode}
         </if>
        </where>-->
    </select>

    <select id="queryList" resultType="com.lcworld.entity.TBxwxOrderEntity">
        select * from t_bxwx_order o
        <where>
            <if test="uid != null">o.uid = #{uid}</if>
            <if test="payordercode != null and payordercode.trim() != ''">and o.ordercode = #{payordercode}</if>

        </where>

        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
            <otherwise>
                order by o.createtime desc
            </otherwise>
        </choose>
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>
    </select>

    <select id="queryTotal" resultType="int">
        select count(*) from t_bxwx_order o
        <where>
            <if test="uid != null">o.uid = #{uid}</if>
        </where>
    </select>

    <insert id="save" parameterType="com.lcworld.entity.TBxwxOrderEntity" useGeneratedKeys="true" keyProperty="id">
        insert into t_bxwx_order
        (
            `menditem`, 
            `username`, 
            `mobile`, 
            `invitetime`, 
            `build_id`,
            `serviceplace`,
            `menderid`, 
            `mendcontent`, 
            `mendimgs`, 
            `price`, 
            `orderstatus`, 
            `uid`, 
            `createtime`, 
            `invitetimetype`, 
            `orderchange`, 
            `ordercode`, 
            `paystatus`, 
            `isdel`,
            `paytype`,
            `cancelreason`,
            `realdel`
        )
        values
        (
            #{menditem}, 
            #{username}, 
            #{mobile}, 
            #{invitetime}, 
            #{buildId},
            #{serviceplace},
            #{menderid}, 
            #{mendcontent}, 
            #{mendimgs}, 
            #{price}, 
            #{orderstatus}, 
            #{uid}, 
            #{createtime}, 
            #{invitetimetype}, 
            #{orderchange}, 
            #{ordercode}, 
            #{paystatus}, 
            #{isdel},
            #{paytype},
            #{cancelreason},
            #{realdel}
            
        )
    </insert>

    <update id="update" parameterType="com.lcworld.entity.TBxwxOrderEntity">
        update t_bxwx_order
        <set>
            <if test="menditem != null">`menditem` = #{menditem},</if>
            <if test="username != null">`username` = #{username},</if>
            <if test="mobile != null">`mobile` = #{mobile},</if>
            <if test="invitetime != null">`invitetime` = #{invitetime},</if>
            <if test="buildId != null">`build_id` = #{buildId},</if>
            <if test="serviceplace != null">`serviceplace` = #{serviceplace},</if>
            <if test="menderid != null">`menderid` = #{menderid},</if>
            <if test="mendcontent != null">`mendcontent` = #{mendcontent},</if>
            <if test="mendimgs != null">`mendimgs` = #{mendimgs},</if>
            <if test="price != null">`price` = #{price},</if>
            <if test="orderstatus != null">`orderstatus` = #{orderstatus},</if>
            <if test="uid != null">`uid` = #{uid},</if>
            <if test="createtime != null">`createtime` = #{createtime},</if>
            <if test="invitetimetype != null">`invitetimetype` = #{invitetimetype},</if>
            <if test="orderchange != null">`orderchange` = #{orderchange},</if>
            <if test="ordercode != null">`ordercode` = #{ordercode},</if>
            <if test="paystatus != null">`paystatus` = #{paystatus},</if>
            <if test="isdel != null">`isdel` = #{isdel},</if>
            <if test="paytype != null">`paytype` = #{paytype},</if>
            <if test="cancelreason != null">`cancelreason` = #{cancelreason},</if>
            <if test="realdel != null">`realdel` = #{realdel}</if>
        </set>
        where id = #{id}
    </update>

    <delete id="delete">
        delete from t_bxwx_order where id = #{value}
    </delete>

    <delete id="deleteBatch">
        delete from t_bxwx_order where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="queryOrderlist" resultType="com.lcworld.dto.BxwxOrderDTO">
        SELECT
        a.id,
        a.uid,
        a.username,
        a.ordercode,
        a.mobile phone,
        a.orderstatus,
        a.orderchange,
        a.invitetime,
        a.menderid,
        tus.photo avatar,
        a.build_id,
        a.serviceplace,
        a.mendcontent,
        build.build_name,
        b.`name` AS itemname,
        c.mobile mendermobile,
        c.photo menderphoto,
        c.realname mendername,
        date_format(a.createtime,'%Y-%m-%d') createtime
        FROM

        <choose>
            <when test="orderstatus == 5">
                t_bxwx_order_cancel tboc
                JOIN t_bxwx_order a on tboc.order_id=a.id
            </when>
            <otherwise>
                t_bxwx_order a
            </otherwise>
        </choose>

        JOIN t_bxwx_item b ON a.menditem = b.id
        left JOIN t_bxwx_mender c ON a.menderid = c.id
        left JOIN t_user tus on a.uid =tus.id
        LEFT JOIN t_building build ON build.id = a.build_id
        WHERE
        1=1

        <choose>
            <when test="search_by_wxd != null">
                <choose>
                    <when test="orderstatus == 5">
                        AND tboc.menderid = #{uid}
                    </when>
                    <otherwise>
                        AND (a.menderid = #{uid} 
                        
                        <if test="orderstatus == 1">
                        OR a.menderid is null
                        </if>
                        )
                        
                        <choose>
                        	<when test="orderstatus == 3">AND a.orderstatus in (3,4)</when>
                        	<otherwise>AND a.orderstatus = #{orderstatus}</otherwise>
                        </choose>
                        
                        AND a.id not in (SELECT t.order_id FROM t_bxwx_order_refuse t WHERE t.mender_id = #{uid})
                    </otherwise>
                </choose>
                AND a.realdel = 0
            </when>
            <otherwise>
                and a.uid = #{uid}
                and a.isdel = 0
            </otherwise>
        </choose>


        <if test="statuslist != null and statuslist.size > 0">
            and a.orderstatus in
            <foreach item="id" collection="statuslist" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>

        <choose>
            <when test="sidx != null and sidx.trim() != ''">
                order by ${sidx} ${order}
            </when>
            <otherwise>
                order by a.id desc
            </otherwise>
        </choose>
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>
    </select>
    <select id="queryOrderDetail" resultType="com.lcworld.dto.BxwxOrderDTO">
       SELECT
            a.id,
		    a.uid,
		    a.username,
		    a.mobile phone,
		    a.build_id,
		    build.build_name,
		    a.serviceplace,
		    a.createtime,
		    a.invitetime,
		    a.ordercode,
		    a.orderstatus,
		    a.orderchange,
		    a.menderid,
		    a.mendcontent,
		    a.mendimgs,
		    b.`name` AS itemname,
		    c.mobile mendermobile,
		    c.photo menderphoto,
		    c.realname mendername,
		    date_format(a.createtime,'%Y-%m-%d') createtime,
		    a.paystatus,
		    c.score
		FROM
		    t_bxwx_order a
		INNER JOIN t_bxwx_item b ON a.menditem = b.id
		left JOIN t_bxwx_mender c ON a.menderid = c.id
		LEFT JOIN t_building build ON build.id = a.build_id
		WHERE a.id = #{orderid}
     
    </select>


    <select id="queryordermapList" resultType="map">
        SELECT
        a.*,b.`name` itemname,c.realname,build.build_name
        FROM
        t_bxwx_order a
        INNER JOIN t_bxwx_item b ON a.menditem = b.id
        left JOIN t_bxwx_mender c ON a.menderid = c.id
        LEFT JOIN t_building build ON build.id = a.build_id
        WHERE 1=1
        <if test="uid != null">o.uid = #{uid}</if>
        <if test="ordercode != null and ordercode != ''">and a.ordercode like '%${ordercode}%'</if>
        <if test="username != null and username != ''">and a.username like '%${username}%'</if>
        <if test="mendername != null and mendername != ''">and c.realname like '%${mendername}%'</if>
        <if test="status != null and status != ''">and a.orderstatus = #{status}</if>
        <if test="paystatus != null and paystatus != ''">and a.paystatus = #{paystatus}</if>
        <if test="starttime != null and starttime != ''">and a.createtime &gt;= str_to_date(#{starttime},'%Y-%m-%d
            %H:%i')
        </if>
        <if test="endtime != null and endtime != ''">and a.createtime &lt;= str_to_date(#{endtime},'%Y-%m-%d %H:%i')
        </if>
        order by a.createtime desc
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>
    </select>

    <select id="queryordermapTotal" resultType="int">
        SELECT
        count(*)
        FROM
        t_bxwx_order a
        INNER JOIN t_bxwx_item b ON a.menditem = b.id
        left JOIN t_bxwx_mender c ON a.menderid = c.id
        WHERE 1=1
        <if test="uid != null">o.uid = #{uid}</if>
        <if test="ordercode != null and ordercode != ''">and a.ordercode like '%${ordercode}%'</if>
        <if test="username != null and username != ''">and a.username like '%${username}%'</if>
        <if test="mendername != null and mendername != ''">and c.realname like '%${mendername}%'</if>
        <if test="status != null and status != ''">and a.orderstatus = #{status}</if>
        <if test="paystatus != null and paystatus != ''">and a.paystatus = #{paystatus}</if>
        <if test="starttime != null and starttime != ''">and a.createtime &gt;= str_to_date(#{starttime},'%Y-%m-%d
            %H:%i')
        </if>
        <if test="endtime != null and endtime != ''">and a.createtime &lt;= str_to_date(#{endtime},'%Y-%m-%d %H:%i')
        </if>
    </select>

    <delete id="deleteOrder">
        delete from t_bxwx_order where orderstatus = #{value}
    </delete>

    <insert id="saveOrderCancel">
    	insert into t_bxwx_order_cancel(order_id,menderid,cancel_time,cancel_reason)
    	values (#{order_id},#{menderid},#{cancel_time},#{cancel_reason})
    </insert>

    <update id="updateOrderMenderIdNull">
    	update t_bxwx_order set menderid=null where id=#{orderId}
    </update>

    <update id="cancelOrder">
    	update t_bxwx_order set menderid=null,orderstatus=1 where id =#{id}
    </update>

    <delete id="deleteProcesses">
    	delete from t_bxwx_order_processes where orderid=#{orderId}
    </delete>

    <delete id="deleteCancelOrder">
    	delete from t_bxwx_order_cancel where order_id=#{id} and menderid=#{menderid}
    </delete>

    <update id="deleteOverOrder">
    	update t_bxwx_order set realdel = 1 where id=#{orderId}
    </update>

    <insert id="refuseOrder">
    	insert into t_bxwx_order_refuse(order_id,mender_id,refuse_time)
    	values (#{orderId},#{uid},now())
    </insert>

</mapper>